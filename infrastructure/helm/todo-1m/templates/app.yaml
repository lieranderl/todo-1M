apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "todo1m.fullname" . }}-command-api
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "todo1m.labels" . | nindent 4 }}
    app.kubernetes.io/component: command-api
spec:
  replicas: {{ .Values.services.commandApi.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: command-api
  template:
    metadata:
      labels:
        {{- include "todo1m.labels" . | nindent 8 }}
        app.kubernetes.io/component: command-api
    spec:
      terminationGracePeriodSeconds: 30
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      containers:
        - name: command-api
          image: {{ .Values.services.commandApi.image | quote }}
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
          envFrom:
            - configMapRef:
                name: {{ include "todo1m.fullname" . }}-app-config
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "todo1m.fullname" . }}-db-app
                  key: uri
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ include "todo1m.fullname" . }}-app-secrets
                  key: jwt-secret
          startupProbe:
            httpGet:
              path: /readyz
              port: http
            periodSeconds: 2
            failureThreshold: 60
          readinessProbe:
            httpGet:
              path: /readyz
              port: http
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 3
          resources:
            {{- toYaml .Values.services.commandApi.resources | nindent 12 }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "todo1m.fullname" . }}-command-api
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "todo1m.labels" . | nindent 4 }}
    app.kubernetes.io/component: command-api
spec:
  selector:
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: command-api
  ports:
    - name: http
      port: 8080
      targetPort: http
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "todo1m.fullname" . }}-sse-streamer
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "todo1m.labels" . | nindent 4 }}
    app.kubernetes.io/component: sse-streamer
spec:
  replicas: {{ .Values.services.sseStreamer.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: sse-streamer
  template:
    metadata:
      labels:
        {{- include "todo1m.labels" . | nindent 8 }}
        app.kubernetes.io/component: sse-streamer
    spec:
      terminationGracePeriodSeconds: 30
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      containers:
        - name: sse-streamer
          image: {{ .Values.services.sseStreamer.image | quote }}
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8081
          envFrom:
            - configMapRef:
                name: {{ include "todo1m.fullname" . }}-app-config
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "todo1m.fullname" . }}-db-app
                  key: uri
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ include "todo1m.fullname" . }}-app-secrets
                  key: jwt-secret
          startupProbe:
            httpGet:
              path: /readyz
              port: http
            periodSeconds: 2
            failureThreshold: 60
          readinessProbe:
            httpGet:
              path: /readyz
              port: http
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 3
          resources:
            {{- toYaml .Values.services.sseStreamer.resources | nindent 12 }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "todo1m.fullname" . }}-sse-streamer
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "todo1m.labels" . | nindent 4 }}
    app.kubernetes.io/component: sse-streamer
spec:
  selector:
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: sse-streamer
  ports:
    - name: http
      port: 8081
      targetPort: http
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "todo1m.fullname" . }}-domain-engine
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "todo1m.labels" . | nindent 4 }}
    app.kubernetes.io/component: domain-engine
spec:
  replicas: {{ .Values.services.domainEngine.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: domain-engine
  template:
    metadata:
      labels:
        {{- include "todo1m.labels" . | nindent 8 }}
        app.kubernetes.io/component: domain-engine
    spec:
      terminationGracePeriodSeconds: 30
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      containers:
        - name: domain-engine
          image: {{ .Values.services.domainEngine.image | quote }}
          imagePullPolicy: Always
          ports:
            - name: health
              containerPort: 8082
          envFrom:
            - configMapRef:
                name: {{ include "todo1m.fullname" . }}-app-config
          startupProbe:
            httpGet:
              path: /readyz
              port: health
            periodSeconds: 2
            failureThreshold: 60
          readinessProbe:
            httpGet:
              path: /readyz
              port: health
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /healthz
              port: health
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 3
          resources:
            {{- toYaml .Values.services.domainEngine.resources | nindent 12 }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "todo1m.fullname" . }}-data-sink
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "todo1m.labels" . | nindent 4 }}
    app.kubernetes.io/component: data-sink
spec:
  replicas: {{ .Values.services.dataSink.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: data-sink
  template:
    metadata:
      labels:
        {{- include "todo1m.labels" . | nindent 8 }}
        app.kubernetes.io/component: data-sink
    spec:
      terminationGracePeriodSeconds: 30
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      containers:
        - name: data-sink
          image: {{ .Values.services.dataSink.image | quote }}
          imagePullPolicy: Always
          ports:
            - name: health
              containerPort: 8083
          envFrom:
            - configMapRef:
                name: {{ include "todo1m.fullname" . }}-app-config
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "todo1m.fullname" . }}-db-app
                  key: uri
          startupProbe:
            httpGet:
              path: /readyz
              port: health
            periodSeconds: 2
            failureThreshold: 60
          readinessProbe:
            httpGet:
              path: /readyz
              port: health
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /healthz
              port: health
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 3
          resources:
            {{- toYaml .Values.services.dataSink.resources | nindent 12 }}
